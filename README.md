# TCPImg - TCP图像传输接收程序

## 项目概述

TCPImg 是一个基于Qt框架开发的TCP网络图像传输接收程序。该程序能够通过TCP连接接收远程发送的图像数据，并在本地界面上实时显示接收到的图像。项目主要用于网络图像传输和显示，特别适用于工业监控、远程图像传输等场景。

## 项目架构

### 核心组件

1. **主程序入口 (main.cpp)**
   - 创建Qt应用程序实例
   - 初始化并显示主对话框

2. **用户界面 (Dialog类)**
   - **dialog.h/dialog.cpp**: 主界面控制类
   - **dialog.ui**: 用户界面布局文件
   - 功能：提供TCP连接配置界面和图像显示区域

3. **TCP图像传输 (CTCPImg类)**
   - **ctcpimg.h/ctcpimg.cpp**: TCP网络通信核心类
   - 功能：处理TCP连接、数据接收和图像缓冲管理

4. **系统定义 (sysdefine.h)**
   - 定义图像尺寸和通道数等关键参数

### 项目配置
- **TCPImg.pro**: Qt项目配置文件，定义编译选项和依赖库

## 功能特性

### 主要功能
1. **TCP网络连接**
   - 支持自定义IP地址和端口号连接
   - 默认连接地址：192.168.1.31:17777
   - 自动重连和断线处理

2. **图像数据接收**
   - 支持1024x1024分辨率的灰度图像
   - 双通道图像数据处理
   - 实时数据缓冲和显示

3. **用户界面**
   - 直观的连接配置界面
   - 大尺寸图像显示区域(1411x881像素)
   - 实时图像更新显示

## 技术细节

### 图像参数配置
```cpp
#define WIDTH   1024    // 图像宽度
#define HEIGHT  1024    // 图像高度  
#define CHANLE  2       // 图像通道数
```

### 数据传输协议
1. **数据尺寸协商**：
   - 服务端先发送格式为"size=数字"的消息，告知图像数据大小
   - 客户端解析size参数，准备接收相应大小的数据

2. **图像数据传输**：
   - 服务端发送原始图像数据
   - 客户端接收并累积数据直到达到预期大小
   - 数据接收完成后发送"OK"确认消息

3. **图像显示**：
   - 将接收到的数据转换为QImage格式
   - 支持灰度图像显示(Format_Grayscale8)
   - 通过信号槽机制实现实时更新

## 使用说明

### 环境要求
- Qt 5.x 或更高版本
- 支持Qt Network模块
- C++编译器支持

### 编译运行
1. **使用Qt Creator**：
   - 打开TCPImg.pro项目文件
   - 配置编译环境
   - 点击构建并运行

2. **命令行编译**：
   ```bash
   qmake TCPImg.pro
   make
   ./TCPImg
   ```

### 操作步骤
1. **启动程序**：运行编译好的TCPImg可执行文件
2. **配置连接**：
   - 在IP地址输入框输入服务端地址（默认：192.168.1.31）
   - 在端口输入框输入端口号（默认：17777）
3. **建立连接**：点击"Start"按钮开始连接
4. **查看图像**：连接成功后，图像将自动显示在主显示区域

## 代码结构解析

### 类关系图
```
Dialog (主界面)
├── CTCPImg (TCP通信)
│   ├── QTcpSocket (网络连接)
│   └── frameBuffer (图像缓冲)
├── QImage (图像处理)
└── UI组件 (用户界面)
```

### 关键流程
1. **连接建立流程**：
   ```
   用户点击Start → Dialog调用CTCPImg::start() → 
   建立TCP连接 → 触发connected信号 → 准备接收数据
   ```

2. **数据接收处理流程**：
   ```
   接收数据 → 解析size消息 → 累积图像数据 → 
   数据完整 → 更新frameBuffer → 发射tcpImgReadySig信号 → 
   Dialog更新显示 → 发送OK确认
   ```

## 扩展建议

### 功能改进
1. **多图像格式支持**：添加RGB彩色图像支持
2. **图像缩放功能**：支持图像缩放和适应窗口显示
3. **连接状态显示**：添加连接状态指示器
4. **图像保存功能**：支持将接收的图像保存到本地

### 性能优化
1. **内存管理优化**：改进缓冲区管理策略
2. **网络性能优化**：添加数据压缩支持
3. **多线程处理**：将网络通信移到独立线程

### 错误处理加强
1. **网络异常处理**：添加更完善的错误恢复机制
2. **数据校验**：添加数据完整性校验
3. **日志系统**：实现详细的操作日志记录

## 最新改进内容 ✨

### 已完成的重要改进
1. **✅ 修复内存管理问题**
   - 修复析构函数中的内存释放错误
   - 使用正确的`delete[]`释放数组内存
   - 添加空指针检查和异常处理

2. **✅ 完善错误处理机制**
   - 新增网络错误处理槽函数`slot_socketError()`
   - 添加详细的中文错误提示信息
   - 实现连接状态检查和数据有效性验证
   - 添加输入参数验证（IP地址、端口号格式检查）

3. **✅ 增强数据校验功能**
   - 添加数据大小范围检查（防止超大数据攻击）
   - 实现数据传输进度显示
   - 增加数据完整性保护机制
   - 添加网络异常恢复处理

4. **✅ 完善中文注释系统**
   - 为所有类、函数、成员变量添加详细的中文注释
   - 使用Doxygen格式的文档注释
   - 添加参数说明和返回值描述
   - 提供使用示例和注意事项

5. **✅ 改进用户界面体验**
   - 添加连接状态实时反馈
   - 实现按钮状态管理（防止重复点击）
   - 增加图像自动缩放以适应显示区域
   - 提供更友好的错误提示信息

6. **✅ 增强调试和监控**
   - 添加详细的运行日志输出
   - 实现数据传输进度监控
   - 增加图像处理状态跟踪
   - 提供网络连接诊断信息

## 注意事项

1. **网络环境**：确保客户端和服务端网络连通
2. **防火墙设置**：检查防火墙是否阻止相关端口
3. **内存使用**：程序运行时会占用约2MB内存用于图像缓冲
4. **数据格式**：当前版本只支持1024x1024的特定格式图像
5. **⚠️ 通道数配置**：注意`sysdefine.h`中`CHANLE`的拼写错误（应为CHANNEL）

## 问题排查

### 常见问题及解决方案
1. **连接失败**：
   - 检查IP地址和端口号是否正确
   - 查看控制台输出的详细错误信息
   - 确认服务器是否正在运行并监听指定端口

2. **图像不显示**：
   - 确认数据格式和大小是否匹配
   - 检查图像参数配置（WIDTH、HEIGHT、CHANLE）
   - 查看是否有数据完整性错误提示

3. **程序崩溃**：
   - 新版本已修复内存管理问题
   - 检查系统内存是否充足
   - 查看是否有异常错误日志

4. **数据传输异常**：
   - 检查网络连接稳定性
   - 确认数据大小是否在合理范围内
   - 查看传输进度信息和错误提示

### 调试信息
程序在运行时会输出以下详细调试信息：
- TCP连接状态和错误详情
- 数据接收进度和大小统计
- 图像处理状态和格式信息
- 内存分配和释放状态
- 用户操作和输入验证结果

---

**项目创建时间**：2022-05-21  
**开发环境**：Qt Creator with Qt 6.8.2  
**编译器**：MinGW 64-bit 