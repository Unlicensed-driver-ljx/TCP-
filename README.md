# TCP图像传输程序 - 智能重连版本

**版本：v2.2.4**  
**更新时间：2024-01-15**  
**主要功能：TCP图像接收、显示、智能重连、服务端诊断、分辨率预设、图像缩放**

## 项目概述

TCPImg 是一个基于Qt框架开发的TCP网络图像传输接收程序。该程序能够通过TCP连接接收远程发送的图像数据，并在本地界面上实时显示接收到的图像。项目主要用于网络图像传输和显示，特别适用于工业监控、远程图像传输等场景。

**🆕 v2.0 重大更新：集成网络调试工具**

本版本新增了强大的网络调试功能，使程序不仅能处理图像传输，还能作为通用的TCP网络调试工具使用：

### 新增网络调试功能特性
- ✅ **多种工作模式**：客户端模式和服务器模式
- ✅ **多格式数据显示**：原始文本、十六进制、二进制、ASCII、JSON、混合显示
- ✅ **实时数据统计**：连接状态、传输速率、数据包计数
- ✅ **双向数据传输**：既能接收数据，也能发送调试数据
- ✅ **时间戳标记**：可选的时间戳显示功能
- ✅ **连接管理**：支持多客户端连接（服务器模式）
- ✅ **智能格式检测**：自动检测数据格式并建议最佳显示方式

## 项目架构

### 核心组件

1. **主程序入口 (main.cpp)**
   - 创建Qt应用程序实例
   - 初始化并显示主对话框

2. **用户界面 (Dialog类)**
   - **dialog.h/dialog.cpp**: 主界面控制类
   - **dialog.ui**: 用户界面布局文件
   - 功能：提供TCP连接配置界面和图像显示区域

3. **TCP图像传输 (CTCPImg类)**
   - **ctcpimg.h/ctcpimg.cpp**: TCP网络通信核心类
   - 功能：处理TCP连接、数据接收和图像缓冲管理

4. **系统定义 (sysdefine.h)**
   - 定义图像尺寸和通道数等关键参数

5. **网络调试模块 (新增)**
   - **tcpdebugger.h/tcpdebugger.cpp**: TCP网络调试器核心类
   - **dataformatter.h/dataformatter.cpp**: 数据格式化处理类
   - 功能：提供通用TCP调试、多格式数据显示、连接统计

### 项目配置
- **TCPImg.pro**: Qt项目配置文件，定义编译选项和依赖库

## 功能特性

### 主要功能
1. **TCP网络连接**
   - 支持自定义IP地址和端口号连接
   - 默认连接地址：192.168.1.31:17777
   - 自动重连和断线处理

2. **图像数据接收**
   - 支持1024x1024分辨率的灰度图像
   - 双通道图像数据处理
   - 实时数据缓冲和显示

3. **用户界面**
   - 直观的连接配置界面
   - 大尺寸图像显示区域(1411x881像素)
   - 实时图像更新显示

## 技术细节

### 图像参数配置
```cpp
#define WIDTH   1024    // 图像宽度
#define HEIGHT  1024    // 图像高度  
#define CHANLE  2       // 图像通道数
```

### 数据传输协议
1. **数据尺寸协商**：
   - 服务端先发送格式为"size=数字"的消息，告知图像数据大小
   - 客户端解析size参数，准备接收相应大小的数据

2. **图像数据传输**：
   - 服务端发送原始图像数据
   - 客户端接收并累积数据直到达到预期大小
   - 数据接收完成后发送"OK"确认消息

3. **图像显示**：
   - 将接收到的数据转换为QImage格式
   - 支持灰度图像显示(Format_Grayscale8)
   - 通过信号槽机制实现实时更新

## 使用说明

### 环境要求
- **Windows**: Qt 5.x/Qt 6.x
- **Linux**: Qt 5.12 及以上版本（推荐）
- 支持Qt Network模块
- C++11编译器支持

### 编译运行

#### 🖥️ Windows环境
1. **使用Qt Creator**：
   - 打开TCPImg.pro项目文件
   - 配置编译环境
   - 点击构建并运行

2. **命令行编译**：
   ```bash
   qmake TCPImg.pro
   make
   ./TCPImg
   ```

#### 🐧 Linux环境（Qt 5.12+）
**方法1：使用自动编译脚本（推荐）**
```bash
# 赋予脚本执行权限
chmod +x build_linux.sh

# 运行编译脚本
./build_linux.sh

# 脚本会自动完成以下步骤：
# - 检查Qt版本
# - 清理构建文件
# - 配置并编译项目
# - 输出编译结果
```

**方法2：手动编译**
```bash
# 创建构建目录
mkdir -p build
cd build

# 配置项目（确保使用Qt 5.12+）
qmake ../TCPImg.pro

# 编译项目（使用所有CPU核心）
make -j$(nproc)

# 运行程序
./TCPImg
```

**方法3：使用Qt Creator (Linux)**
```bash
# 安装Qt Creator（Ubuntu/Debian）
sudo apt-get install qtcreator qt5-default

# 或者在其他Linux发行版上安装相应的Qt开发包
# 然后打开项目文件
qtcreator TCPImg.pro
```

#### 🔧 Linux依赖安装
**Ubuntu/Debian系统：**
```bash
# 安装Qt 5.12开发环境
sudo apt-get update
sudo apt-get install qt5-default qtbase5-dev qttools5-dev-tools

# 安装网络模块（通常已包含在qtbase5-dev中）
sudo apt-get install qtbase5-dev
```

**CentOS/RHEL/Fedora系统：**
```bash
# Fedora
sudo dnf install qt5-qtbase-devel qt5-qttools-devel

# CentOS/RHEL (需要EPEL源)
sudo yum install qt5-qtbase-devel qt5-qttools-devel
```

#### ⚠️ Linux注意事项
1. **Qt版本兼容性**：
   - 项目已针对Qt 5.12进行优化
   - 修复了Qt 6特有的信号槽语法
   - 使用传统的SIGNAL/SLOT宏确保最大兼容性

2. **编译器要求**：
   - GCC 4.8+ 或 Clang 3.3+（支持C++11）
   - 项目配置文件自动检查Qt版本

3. **运行时依赖**：
   - 确保安装了Qt运行时库
   - 检查LD_LIBRARY_PATH是否包含Qt库路径

### 操作步骤

#### 📸 图像传输模式（传统功能）
1. **启动程序**：运行编译好的TCPImg可执行文件
2. **选择"图像传输"标签页**
3. **配置连接**：
   - 在IP地址输入框输入服务端地址（默认：192.168.1.31）
   - 在端口输入框输入端口号（默认：17777）
4. **建立连接**：点击"Start"按钮开始连接
5. **查看图像**：连接成功后，图像将自动显示在主显示区域

#### 🔧 网络调试模式（新增功能）
1. **启动程序**：运行编译好的TCPImg可执行文件
2. **选择"网络调试"标签页**
3. **选择工作模式**：
   - **客户端模式**：连接到远程服务器进行调试
   - **服务器模式**：创建本地服务器等待客户端连接
4. **配置连接参数**：
   - 客户端模式：输入目标主机IP和端口
   - 服务器模式：选择本地IP地址和监听端口
5. **选择数据显示格式**：
   - 原始文本：直接显示接收到的文本数据
   - 十六进制：以HEX格式显示，便于查看二进制数据
   - 二进制：显示每个字节的二进制表示
   - ASCII：显示ASCII码值和对应字符
   - JSON：自动格式化JSON数据
   - 混合显示：同时显示多种格式
6. **启动调试**：点击"开始"按钮建立连接
7. **数据交互**：
   - 在接收窗口查看格式化的接收数据
   - 在发送框输入数据并点击"发送"进行双向调试
   - 查看实时连接统计信息

#### 🔄 自动重连功能

**智能重连机制：**
- **自动检测**：连接断开时自动触发重连
- **可配置参数**：最大5次尝试，3秒间隔
- **手动控制**：支持立即重连和停止重连
- **状态监控**：实时显示连接状态和重连进度

**可视化重连界面：**
```
🔗 连接控制
┌─────────────────────────────────────────────────────────┐
│ 🟢 已连接  ☑️ 🔄 自动重连  🚀 立即重连  🔍 诊断    │
│ ✅ 连接正常                                             │
│ ████████████████████ 100%                               │
└─────────────────────────────────────────────────────────┘
```

**重连状态说明：**
- **⏳ 等待重连触发**：连接断开，准备开始重连
- **🔄 重连中 (第X/5次)**：显示当前重连尝试次数
- **⏱️ X秒后重试**：倒计时显示下次重连时间
- **🔍 正在诊断服务端状态**：重连失败后自动诊断
- **❌ 连接失败：已尝试5次**：达到最大尝试次数后显示
- **✅ 连接正常**：重连成功或连接稳定
- **🚫 自动重连已禁用**：用户关闭自动重连功能

#### 🔍 智能诊断功能（v2.2.2新增）

**自动诊断触发：**
- 当自动重连5次失败后，自动执行服务端诊断
- 检查网络连通性、服务端状态、采集端程序状态

**手动诊断功能：**
- **🔍 诊断按钮**：随时手动触发诊断检查
- **实时网络测试**：测试到服务端的TCP连接
- **详细诊断报告**：在控制台输出完整诊断信息

**诊断检查项目：**
1. **网络连通性检查**
   - TCP连接测试（3秒超时）
   - 错误类型分析和建议

2. **服务端状态分析**
   - 服务端程序运行状态
   - 端口监听状态检查
   - 图像数据发送状态
   - 网络配置检查

3. **采集端程序检查**
   - 图像采集设备连接状态
   - 采集程序运行状态
   - 图像数据输出检查
   - 网络发送功能检查

4. **网络环境检查**
   - 客户端与服务端连通性
   - 防火墙端口检查
   - 路由器/交换机配置
   - 网络带宽评估

**诊断报告示例：**
```
🔍 ==================== 服务端诊断报告 ====================
🔍 连接目标：192.168.1.18:17777
🔍 重连尝试：5/5次
🔍 诊断时间：2024-01-15 14:30:25

🔍 【步骤1】网络连通性检查
🔍 连通性结果：❌ 连接被拒绝 - 服务端可能未启动或端口未监听

🔍 【步骤2】服务端状态分析
🔍 ✅ 请检查以下项目：
🔍    1. 服务端程序是否正在运行？
🔍    2. 服务端是否监听在端口17777？
🔍    3. 服务端是否有图像数据可发送？
🔍    4. 服务端网络配置是否正确？

🔍 【步骤3】采集端程序检查
🔍 ✅ 请检查以下项目：
🔍    1. 图像采集设备是否正常连接？
🔍    2. 采集程序是否正常运行？
🔍    3. 采集程序是否有图像数据输出？
🔍    4. 采集程序网络发送是否正常？

🔍 【建议操作】
🔍 💡 1. 手动重连：点击'立即重连'按钮重新尝试
🔍 💡 2. 检查服务端：确认服务端程序正在运行并监听端口
🔍 💡 3. 检查采集端：确认图像采集程序正常工作
🔍 💡 4. 网络测试：使用ping/telnet等工具测试网络连通性
🔍 💡 5. 重启服务：重启服务端和采集端程序
🔍 💡 6. 联系技术支持：如问题持续存在，请联系技术支持
🔍 ========================================================
```

## 代码结构解析

### 类关系图
```
Dialog (主界面)
├── CTCPImg (TCP通信)
│   ├── QTcpSocket (网络连接)
│   └── frameBuffer (图像缓冲)
├── QImage (图像处理)
└── UI组件 (用户界面)
```

### 关键流程
1. **连接建立流程**：
   ```
   用户点击Start → Dialog调用CTCPImg::start() → 
   建立TCP连接 → 触发connected信号 → 准备接收数据
   ```

2. **数据接收处理流程**：
   ```
   接收数据 → 解析size消息 → 累积图像数据 → 
   数据完整 → 更新frameBuffer → 发射tcpImgReadySig信号 → 
   Dialog更新显示 → 发送OK确认
   ```

## 扩展建议

### 功能改进
1. **多图像格式支持**：添加RGB彩色图像支持
2. **图像缩放功能**：支持图像缩放和适应窗口显示
3. **连接状态显示**：添加连接状态指示器
4. **图像保存功能**：支持将接收的图像保存到本地

### 性能优化
1. **内存管理优化**：改进缓冲区管理策略
2. **网络性能优化**：添加数据压缩支持
3. **多线程处理**：将网络通信移到独立线程

### 错误处理加强
1. **网络异常处理**：添加更完善的错误恢复机制
2. **数据校验**：添加数据完整性校验
3. **日志系统**：实现详细的操作日志记录

## 最新改进内容 ✨

### 已完成的重要改进
1. **✅ 修复内存管理问题**
   - 修复析构函数中的内存释放错误
   - 使用正确的`delete[]`释放数组内存
   - 添加空指针检查和异常处理

2. **✅ 完善错误处理机制**
   - 新增网络错误处理槽函数`slot_socketError()`
   - 添加详细的中文错误提示信息
   - 实现连接状态检查和数据有效性验证
   - 添加输入参数验证（IP地址、端口号格式检查）

3. **✅ 增强数据校验功能**
   - 添加数据大小范围检查（防止超大数据攻击）
   - 实现数据传输进度显示
   - 增加数据完整性保护机制
   - 添加网络异常恢复处理

4. **✅ 完善中文注释系统**
   - 为所有类、函数、成员变量添加详细的中文注释
   - 使用Doxygen格式的文档注释
   - 添加参数说明和返回值描述
   - 提供使用示例和注意事项

5. **✅ 改进用户界面体验**
   - 添加连接状态实时反馈
   - 实现按钮状态管理（防止重复点击）
   - 增加图像自动缩放以适应显示区域
   - 提供更友好的错误提示信息

6. **✅ 增强调试和监控**
   - 添加详细的运行日志输出
   - 实现数据传输进度监控
   - 增加图像处理状态跟踪
   - 提供网络连接诊断信息

## 注意事项

1. **网络环境**：确保客户端和服务端网络连通
2. **防火墙设置**：检查防火墙是否阻止相关端口
3. **内存使用**：程序运行时会占用约2MB内存用于图像缓冲
4. **数据格式**：当前版本只支持1024x1024的特定格式图像
5. **⚠️ 通道数配置**：注意`sysdefine.h`中`CHANLE`的拼写错误（应为CHANNEL）

## 问题排查

### 常见问题及解决方案
1. **连接失败**：
   - 检查IP地址和端口号是否正确
   - 查看控制台输出的详细错误信息
   - 确认服务器是否正在运行并监听指定端口

2. **图像不显示**：
   - 确认数据格式和大小是否匹配
   - 检查图像参数配置（WIDTH、HEIGHT、CHANLE）
   - 查看是否有数据完整性错误提示

3. **程序崩溃**：
   - 新版本已修复内存管理问题
   - 检查系统内存是否充足
   - 查看是否有异常错误日志

4. **数据传输异常**：
   - 检查网络连接稳定性
   - 确认数据大小是否在合理范围内
   - 查看传输进度信息和错误提示

### 调试信息
程序在运行时会输出以下详细调试信息：
- TCP连接状态和错误详情
- 数据接收进度和大小统计
- 图像处理状态和格式信息
- 内存分配和释放状态
- 用户操作和输入验证结果

## 🎯 版本历史

### v2.2.4 - UI架构重构版本 (2024-xx-xx)
#### 🎯 重大变更：完全现代化界面
- **🗑️ 移除所有原始UI依赖**：彻底清理dialog.ui文件中的过时控件
- **🚫 删除UI文件控件**：移除 lineEditAddr、lineEditPort、pushButtonStart 等旧控件
- **📱 现代化界面架构**：使用完全编程式界面，不再依赖Qt Designer
- **🎨 统一设计语言**：所有界面元素采用一致的现代化设计风格
- **⚡ 性能优化**：移除UI文件依赖，减少资源占用
- **🔧 代码简化**：移除ui指针和相关初始化代码

#### 🛠️ 技术改进
- **界面组件**：完全使用QGroupBox + QLayout的现代化布局
- **信号连接**：所有连接逻辑集中在代码中，便于维护
- **样式管理**：统一的CSS样式表，支持主题切换
- **控件管理**：所有控件都有明确的生命周期管理

#### ✨ 用户体验提升
- **🎯 功能分区**：图像传输、网络调试、设置选项清晰分离
- **💡 直观操作**：现代化按钮、图标和状态指示
- **📱 响应式设计**：支持窗口缩放和分辨率适配
- **🚀 快速启动**：界面加载更快，响应更流畅

### v2.2.3 - 图像缩放与界面优化版本 (2024-xx-xx)

## 技术支持

如果您在使用过程中遇到问题，请：
1. 首先使用🔍诊断功能检查系统状态
2. 查看控制台输出的详细日志信息
3. 根据诊断报告的建议进行问题排查
4. 如问题持续存在，请联系技术支持团队

**联系方式：**
- 项目地址：[GitHub Repository]
- 技术支持：[Support Email]
- 文档更新：定期更新，请关注最新版本

#### 📏 图像分辨率设置

**分辨率预设选择：**
- **预设下拉框**：提供15种常用分辨率预设，快速选择
- **自定义选项**：保留手动输入功能，满足特殊需求
- **智能切换**：手动修改宽度或高度时自动切换到"自定义"模式

**支持的分辨率预设：**
```
📺 标准分辨率：
• 640x480 (VGA)      - 经典标准分辨率
• 800x600 (SVGA)     - 超级VGA分辨率
• 1024x768 (XGA)     - 扩展图形阵列
• 1280x720 (HD)      - 高清分辨率
• 1280x1024 (SXGA)   - 超级扩展图形阵列
• 1600x1200 (UXGA)   - 超级扩展图形阵列
• 1920x1080 (FHD)    - 全高清分辨率
• 2560x1440 (QHD)    - 四倍高清分辨率
• 3840x2160 (4K)     - 4K超高清分辨率

🔬 专业应用：
• 2048x1536 (QXGA)   - 四倍扩展图形阵列
• 640x2048 (线阵)    - 线阵相机常用
• 1024x2048 (线阵)   - 高分辨率线阵
• 2048x2048 (方形)   - 方形传感器
• 4096x4096 (大方形) - 大尺寸方形传感器
```

**分辨率设置面板：**
```
📏 图像分辨率设置
┌─────────────────────────────────────────────────────────────┐
│ 预设: [1920x1080 (FHD)        ▼]                          │
│ 宽度: [1920] 高度: [1080] 通道: [3 (RGB) ▼] [应用] [重置] │
│ 当前：1920x1080x3 (8bit, 5.93 MB)                          │
└─────────────────────────────────────────────────────────────┘
```

**使用方法：**
1. **快速设置**：从预设下拉框选择常用分辨率
2. **自定义设置**：选择"自定义"后手动输入宽度和高度
3. **智能提示**：系统会显示内存占用和格式信息
4. **自动应用**：选择预设后自动应用新设置
5. **一键重置**：点击"重置"按钮恢复默认设置

**参数范围：**
- **图像宽度**：1-8192像素
- **图像高度**：1-8192像素  
- **通道数**：1-8通道（8位深度）
- **内存限制**：单张图像不超过50MB

**通道格式支持：**
- **1通道**：灰度图像
- **2通道**：双通道图像
- **3通道**：RGB彩色图像
- **4通道**：RGBA彩色图像
- **5-8通道**：多光谱图像（提取第一通道显示）

#### 🔍 图像缩放和窗口调整

**智能缩放系统：**
- **自适应缩放**：默认开启，图像自动适应窗口大小
- **手动缩放**：支持10%-500%的精确缩放控制
- **滚动查看**：大图像支持滚动条查看细节
- **窗口调整**：整个软件界面支持窗口大小调整

**缩放控制面板：**
```
🔍 图像缩放控制
┌─────────────────────────────────────────────────────────────┐
│ [🔍-] ████████████████████ [🔍+] 100% [📐适应窗口] [📏实际大小] │
└─────────────────────────────────────────────────────────────┘
```

**缩放功能特性：**
1. **智能缩放滑块**：拖动调整10%-500%缩放比例
2. **一键缩放按钮**：
   - **🔍-** 缩小按钮：每次缩小25%
   - **🔍+** 放大按钮：每次放大25%
   - **📐 适应窗口**：自动调整图像以适应当前窗口大小
   - **📏 实际大小**：显示图像100%原始尺寸

3. **实时缩放反馈**：
   - 动态显示当前缩放百分比
   - 智能按钮状态控制（禁用无效操作）
   - 平滑缩放过渡效果

4. **窗口自适应**：
   - 在"适应窗口"模式下，调整窗口大小时图像自动重新缩放
   - 保持图像宽高比不变形
   - 智能计算最佳显示尺寸

**使用场景：**
- **概览查看**：适应窗口模式快速查看整体图像
- **细节检查**：放大模式配合滚动条查看图像细节
- **精确测量**：实际大小模式进行像素级精确观察
- **多屏显示**：灵活调整窗口大小适应不同屏幕

**快捷键支持**：
- **Ctrl + +**：放大图像
- **Ctrl + -**：缩小图像
- **Ctrl + 0**：重置为适应窗口模式

**窗口特性：**
- **最小尺寸**：1000x600像素，确保所有控件可见
- **默认尺寸**：1400x900像素，适合大多数屏幕
- **自由调整**：支持任意拖拽调整窗口大小
- **响应式布局**：控件和图像区域智能分配空间